{% extends 'base.html' %}

{% block title %}Тикет #{{ ticket.id }} - Техподдержка{% endblock %}

{% block extra_css %}
<style>
    .ticket-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem 1rem 0 0;
        padding: 2rem;
    }
    
    .ticket-body {
        padding: 2rem;
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .status-open { background-color: #dc3545; color: white; }
    .status-in_progress { background-color: #ffc107; color: #212529; }
    .status-resolved { background-color: #28a745; color: white; }
    .status-closed { background-color: #6c757d; color: white; }
    
    .priority-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .priority-low { background-color: #28a745; color: white; }
    .priority-medium { background-color: #ffc107; color: #212529; }
    .priority-high { background-color: #fd7e14; color: white; }
    .priority-urgent { background-color: #dc3545; color: white; }
    
    .comment-item {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
    }
    
    .comment-item.internal {
        background: #fff3cd;
        border-left-color: #ffc107;
    }
    
    .assignment-form {
        background: #e9ecef;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8">
            <!-- Ticket Header -->
            <div class="card mb-4">
                <div class="ticket-header">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="mb-2">#{{ ticket.id }} - {{ ticket.title }}</h2>
                            <div class="d-flex gap-2 mb-2">
                                <span class="status-badge status-{{ ticket.status }}">
                                    {{ ticket.get_status_display }}
                                </span>
                                <span class="priority-badge priority-{{ ticket.priority }}">
                                    {{ ticket.get_priority_display }}
                                </span>
                                <span class="badge bg-secondary">{{ ticket.get_category_display }}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="opacity-75">
                                Создан: {{ ticket.created_at|date:"d.m.Y H:i" }}<br>
                                Автор: {{ ticket.created_by.get_full_name }}
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="ticket-body">
                    <h5>Описание</h5>
                    <p class="text-muted">{{ ticket.description|linebreaks }}</p>
                    
                    {% if ticket.assigned_to %}
                    <div class="alert alert-info">
                        <i class="bi bi-person-check me-1"></i>
                        <strong>Назначен:</strong> {{ ticket.assigned_to.user.get_full_name }} ({{ ticket.assigned_to.department }})
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Comments -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots me-2"></i>Комментарии ({{ comments|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% for comment in comments %}
                    <div class="comment-item {% if comment.is_internal %}internal{% endif %}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>{{ comment.author.get_full_name }}</strong>
                                {% if comment.is_internal %}
                                <span class="badge bg-warning text-dark ms-2">Внутренний</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                        </div>
                        <p class="mb-0">{{ comment.content|linebreaks }}</p>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">Комментариев пока нет</p>
                    {% endfor %}
                    
                    <!-- Add Comment Form -->
                    <div class="mt-4">
                        <h6>Добавить комментарий</h6>
                        <form method="post" action="{% url 'support:add_comment' ticket.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                {{ comment_form.content }}
                                {% if comment_form.content.errors %}
                                    <div class="text-danger">{{ comment_form.content.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ comment_form.is_internal }}
                                    <label class="form-check-label" for="{{ comment_form.is_internal.id_for_label }}">
                                        Внутренний комментарий (только для сотрудников техподдержки)
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send me-1"></i>Отправить
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Assignment Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-person-gear me-2"></i>Назначение
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'support:assign_ticket' ticket.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="{{ assignment_form.assigned_to.id_for_label }}" class="form-label">Назначить сотруднику</label>
                            {{ assignment_form.assigned_to }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ assignment_form.status.id_for_label }}" class="form-label">Статус</label>
                            {{ assignment_form.status }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ assignment_form.priority.id_for_label }}" class="form-label">Приоритет</label>
                            {{ assignment_form.priority }}
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-check-circle me-1"></i>Обновить
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-lightning me-2"></i>Быстрые действия
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'support:dashboard' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Назад к дашборду
                        </a>
                        <a href="{% url 'support:ticket_create' %}" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle me-1"></i>Новый тикет
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}




